# Only here for writeup purpose

import base64
from Crypto.Util import strxor
import binascii

def xor(a,b):
    return strxor.strxor(a,b)

test_message = "Walder Frey eventually holds a hand up to cue the musicians to cease playing, addressing Robb and claiming that he has been negligent in his duties as a host by failing to present his king with a proper wedding gift. At this moment, Roose Bolton gives Catelyn a knowing look and glances towards his arm. Her eyes follow his gaze and she sees a bit of chain mail peaking out from his sleeve. She then lifts up his sleeve which reveals the chain mail he is wearing underneath. Roose smiles ominously and Catelyn realizes that they have been led into a trap: she slaps Roose across the face and then shouts to warn Robb, but it is too late. At Walder Frey's signal, Frey approaches Talisa Stark from behind and begins to repeatedly stab her in the abdomen with a dagger, killing her unborn child instantly and causing her to quickly succumb to her wounds. The musicians hired for the wedding reveal themselves to be a group of assassins, brandishing crossbows and firing on Robb Stark and the Northern leadership gathered in the hall.."
test_cipher='P8t1d0rMgqt/f4uGAg4dpyLxMyIR+JJ4hT8DOVAMX54gBVBwuZvZc0Z5LU+Gz/PHRVoWf+8GCsXaOFdVcY7jnXcQFxjqOOnLOo79TvJywdUw1ceM58fPE3Yso97c8DaKzLzf/lXgMn9AJymOjU6239PWGYn5kHjZ/vTGvIIeP4QGk7pxiD8S00LlyRK5+YWw7i435CfQqpIum8zBJXWGvUOtDADrwXD44Fo3TMOdzJaRiLaElTSPrbpXY8d8y1oFT+bC5jgqME38wesLgcc3JNOQO17hg414WXoNtmLMFw7I8pll1zYzMz4/C8uBUZ+g2MRFjtwWffS1S8DwsFq+9vfJNDXAETUsY+lVY2Ng1yEkRSl/xRuJkkNt0A9G5hi0gkoe3cDDLV6pqdCSBKwBwz7+ywb7TbitEybS5u/qkmOdsfoRfEXHYbclbDpwmd2MQ6HQoJi7jI7tEEz4vGw66gI3YSxx0c8NHTx+mSKgxzZnp270crRy8pU4Azvq/IqiDJyqEV0TLZquJ1DcmaWD4GluUGnK9s63ttuQqsghErR/j+NnPQrg5HjkTxlNVZk0xoTTg7q0uh55HloMs7YUQFizXM1pK9k0Uldu09jslAAQSw63yu0rbqHZuUAzG1jNl8x3nPfz9GjwJDcUVSn3hEz4Edc4iu48P3CBTf/4ZADmzjywMCDdxLn4LUjOao0PbUaeWYOjVwlcaxB6zRdfPalwolwCPcu+FoTi77NuJLyr4sSnS962IhJKGM7zeHkP9obk5dps1Ps9BnjsJYDF2CyC7Qplcf/iB2uW/RnjQnyuK72gIx8tBlYz7Qh1Kn2U03FESlfxk5Y3iaL0oq2P1oHkPeAIa7IEY5YLdMLyn7BNYJiXKdnTT4oOENcmHjteLen+lANqMb3wqj7GLjy6B32Vo8cM046+AEAm0mbNZZcQvBUZtbSTue1+8hg4N3s1MIxmAVwBkJQF32beWzw+QKPgaGyOMv84K43ZsOlOZq6gYx5O9PIfzcDCfIxmlhf83TSj5GCcC18tvyIfFBHWVHdj7l2u65X0M9MRN+/2ttnHVVZ7grUon4wseQGHfV4PDiY2LOk5LKw0t+qLsxHzQ0IodSX0QJH09lXxgDsTuIdY7c7f2nb1DiDiMdCMPPmW/aL7c6EwHJZq5O2OsHeZXLHi3WlxhJ+VAI+qOze1cYspwRncYSGsDJL8YrDtTBC841ngSqAHS/OXOEs8Ui2v2vlprvRjf17Bk/JzulSEvJkrweKO7bI29AdnaEzfWB1afaaxFctqBy/IdVjRaC84ajgUdYApyteFGi767rVTgjWjKTACR49hBmj3DIzKidQOYx3M+Fz8FoLujVK4g5fmGWWvh0eoiaaU'
test_ciphers=base64.b64decode(test_cipher)
S1 = xor(test_message,test_ciphers)
S1l = [S1[i:i+8] for i in range(0, len(S1), 8)]

l = lambda x :[int(j) for j in "".join(['{0:08b}'.format(ord(i)) for i in x ])]
S1lb= list(map(l,S1l))

# Let's build the X s.t. K1 X = Y. We call K1 A and K2 B.We can not start with the first S because it is multiplied by IV which is unknown
Xal = [S1lb[i] for i in range(1,129,2)]
Z2 = Integers(2)
Xa = matrix(Z2, Xal).transpose()
Yal = [S1lb[i] for i in range(2,130,2)]
Ya = matrix(Z2, Yal).transpose()
A = Xa.solve_left(Ya)
Xbl = [S1lb[i] for i in range(0,128,2)]
Xb = matrix(Z2, Xbl).transpose()
Ybl = [S1lb[i] for i in range(1,129,2)]
Yb = matrix(Z2, Ybl).transpose()
B = Xb.solve_left(Yb)

# We can also find IV
S0 = vector(Z2,S1lb[0])

IV = A.solve_right(S0)
IVs= "".join([str(i) for i in IV])
IV2 = '{0:064b}'.format(int(IVs, 2)+1)
C52=base64.b64decode('BXkOb8rYcnNpR3db/Ly5cD+EyBJnm8sorjHZTx/yAhUi')
k=""
print("Creating k...")
i=0

# Running the algorithm again now that we have found the prameters
while i*8 < len(C52):
    if i == 0:
        S=A*vector(Z2,IV2)
    elif i%2 == 0:
        S = A*S
    else:
        S=B*S
    sf = "".join([str(j) for j in S])
    sfl = [sf[j:j+8] for j in range(0, len(sf), 8)]
    sfa = "".join(list(map(lambda x : chr(int(x,2)),sfl)))
    k+=sfa
    i+=1

k=k[:len(C52)]
print(xor(k,C52))
